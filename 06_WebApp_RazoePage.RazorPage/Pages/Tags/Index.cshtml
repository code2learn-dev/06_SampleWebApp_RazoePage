@page
@model _06_WebApp_RazoePage.RazorPage.Pages.Tags.IndexModel
@{
	ViewBag.Title = "لیست تگ ها";
	LinkViewModel linkView = new LinkViewModel()
	{
		Caption = "ذخیره تگ جدید",
		PageName = "Add"
	};
}
@section styles {
	<style>
		.modal-header {
			direction: rtl;
			justify-content: space-between;
		}

			.modal-header button.btn-close {
				margin-left: 0 !important;
			}

		.modal-footer {
			direction: rtl;
		}

		#select-action {
			visibility: hidden;
		}
	</style>
}
<table class="table table-striped table-bordered table-responsive">
	<thead>
		<tr>
			<th>ردیف</th>
			<th>نام تگ</th>
			<th>عملیات</th>
		</tr>
	</thead>
	<tbody>
		@if (Model.EntityViewModelList is not null &&
							Model.EntityViewModelList.Any())
		{
			foreach (var tag in Model.EntityViewModelList.Select(
				(item, index) => new { item, index }))
			{
				<tr>
					<td>@(tag.index + 1)</td>
					<td>@tag.item.Name</td>
					<td>
						<a class="btn btn-success btn-sm edit-tag-link" data-bs-toggle="modal" data-bs-target="#edit-tag-modal" data-tag-id="@tag.item.Id" data-tag-name="@tag.item.Name" data-tag-action="2">ویرایش</a>

						<a class="btn btn-danger btn-sm delete-tag-link" data-bs-toggle="modal" data-bs-target="#delete-tag-modal" data-tag-id="@tag.item.Id" data-tag-name="@tag.item.Name" data-tag-action="3">حذف</a>
					</td>
				</tr>
			}
		}
		else
		{
			<tr>
				<td colspan="3">
					<p class="alert alert-warning text-center">تگی یافت نشد</p>
				</td>
			</tr>
		}
	</tbody>
</table>
<section class="card">
	<article class="card-body text-start">
		<button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#add-tag-modal">ایجاد تگ جدید</button>
	</article>
</section>
<div class="modal fade" id="add-tag-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<form method="post">
				<input asp-for="CrudTagViewModel.Id" id="input-tag-id" type="hidden" />
				<div class="modal-header">
					<h1 class="modal-title fs-5" id="staticBackdropLabel">ذخیره تگ جدید</h1>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div class="mt-3">
						<label asp-for="CrudTagViewModel.Name"></label>
						<input asp-for="CrudTagViewModel.Name" class="form-control" id="input-tag-name" />
						<span asp-validation-for="CrudTagViewModel.Name" class="text-danger"></span>
					</div>
				</div>
				<div class="modal-footer">
					<select asp-for="CrudTagViewModel.ActionMethod" asp-items="Html.GetEnumSelectList<ActionMethod>()" id="select-action"></select>
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
					<button type="submit" class="btn btn-primary">ذخیره</button>
				</div>
			</form>
		</div>
	</div>
</div> 
@section scripts {
	<script src="~/scripts/js/bootstrap.min.js"></script>
	<script>
		let editLinks = document.querySelectorAll(".edit-tag-link");
		let deleteLinks = document.querySelectorAll(".delete-tag-link");
		let selectActionList = document.getElementById('select-action');  
		let submitBtn = document.querySelector('form button[type=submit]')
		let modalElement = document.getElementById('add-tag-modal');
		let modal = new bootstrap.Modal(modalElement);

		editLinks.forEach(link => {
			link.addEventListener('click', () => { 
				callCrudModal(link);
			})
		})

		deleteLinks.forEach(link => {
			link.addEventListener('click', () => {
				callCrudModal(link);
			})
		})

		function callCrudModal(link) {
			let tagId = link.dataset.tagId ?? 0;
			let tagName = link.dataset.tagName ?? '';
			let tagAction = parseInt(link.dataset.tagAction ?? '0', 10); 
			selectActionList.value = tagAction;
			let submitCssClass = tagAction === 2 ? 'success' : 'danger';
			let submitCaption = tagAction === 2 ? 'ویرایش' : 'حذف';
			document.getElementById('input-tag-id').value = tagId;
			document.getElementById('input-tag-name').value = tagName;
			document.getElementById('staticBackdropLabel').innerText =
				tagAction === 2 ? 'ویرایش تگ' : 'حذف تگ';
			modal.show(); 
			submitBtn.className = `btn btn-${submitCssClass}`;
			submitBtn.innerText = submitCaption;
		}
	</script>
}

